const User = require("../model/userModel");
const session = require('express-session')
// const sendToken = require("../auth")
const jwt = require('jsonwebtoken')


exports.user_creation = (req, res) => {
    if (!req.body) {
        res.status(400).send({
            message: "Content can not be empty!"
        });
    }
    const user = new User({
        username: req.body.username,
        email: req.body.email,
        password: req.body.password
    });
    User.create(user, (err, data) => {
        if (err){
            res.status(500).send({
            message:
                err.message || "Some error occurred while creating the User."
            });
        } else {
            res.status(200).send(data); // sends data to front-end
        }
    })
};


exports.user_All = (req, res) => {
    User.selectAll((err, data) => {
        if (err) {
            if (err.kind === "not_found") {
                res.status(404).send({
                message: "Somehow, listing all users has encounted a problem"
                });
            } else {
                res.status(500).send({
                message: "Somehow, listing all users has encounted a problem (2)"
                });
            }
        } else res.send(data); // sends data to front-end
    })
};

exports.login = (req, res) => {
    if (!req.body) {
        res.status(400).send({
            message: "Content can not be empty!"
        });
    }
    console.log(req.body.email, req.body.password);
    const email = (req.body.email).toLowerCase();
    console.log(email)
    const password = req.body.password;
    User.authentication(email, password, (err, data) => {
        if (err) {
            console.log(err);
            res.status(400).send("Invalid Credentials");
        } else {
            res.cookie("JWT", data.token)
            res.send(data);
            // res.status(200).redirect("/dashboard");
        }
    })
};


exports.dashboard = (req, res) => {
    // const jwt_cookie = req.cookies.JWT;
    console.log("\n")
    console.log("INFO: req.cookies: ", req.cookies);
    // res.end()
    const token = req.cookies.JWT;
    console.log(token)
    if (token) {
        jwt.verify(token, 'hello', async (err, decodedToken) => {
            const currentUser = decodedToken.username;
            console.log("INFO: Current user's decodedToken: ", decodedToken);
            res.send(currentUser);
        });
    } else {
        console.log('JWT cookie not found')
    }
    return;
};


exports.logout = (req, res) => {
    res.cookie("JWT", 'none', {
        expires: new Date(Date.now()),
        httpOnly: true
    })
    res.status(200).json({
        success: true,
        message: 'Logged out successfully'
    })
    // res.redirect('/')
}


exports.user_details = (req, res) => {
    console.log("\n")
    console.log("INFO: req.cookies: ", req.cookies);
    const token = req.cookies.JWT;
    if (token) {
        jwt.verify(token, 'hello', async (err, decodedToken) => {
            const currentUsername = decodedToken.username;
            console.log("INFO: Current user's decodedToken: ", decodedToken);
            User.selectOne(currentUsername, (err, data) => {
                res.send(data);// sends data to front-end    
            });
        }) 
    } else {
        console.log('JWT cookie not found')
    }
};


exports.update_email = (req, res) => {
    console.log("\n")
    const newEmail = req.body.email;
    const token = req.cookies.JWT;
    if (token) {
        jwt.verify(token, 'hello', async (err, decodedToken) => {
            const currentUsername = decodedToken.username;
            console.log("INFO: Current user's decodedToken: ", decodedToken);
            User.updateEmail(currentUsername, newEmail, (err, data) => {
                res.send(newEmail)
            })
        });
    } else {
        console.log('JWT cookie not found')
    }
};


exports.change_password = (req, res) => {
    console.log("\n")
    console.log(req.body.password)
    const newPwd = req.body.password;
    console.log("INFO: req.cookies in changePwd: ", req.cookies);
    // res.end()
    const token = req.cookies.JWT;
    if (token) {
        jwt.verify(token, 'hello', async (err, decodedToken) => {
            const currentUsername = decodedToken.username;
            console.log("INFO: Current user's decodedToken: ", decodedToken);
            
            User.changePwd(currentUsername, newPwd, (err, data) => {
                res.send(newPwd)
            })
        });
    } else {
        console.log('JWT cookie not found')
    }
};


exports.user_statusList = (req, res) => {
    User.displayUserStatus((err, data) => {
        if (err) {
            res.status(404).send({
            message: "Somehow, listing all users has encounted a problem"
            });
        } else res.send(data); // sends data to front-end
    })
}


exports.user_status = (req, res) => {
    if (!req.body) {
        res.status(400).send({
            message: "Content can not be empty!"
        });
    }
    const status = (req.body.active);
    const username = (req.body.username);
    console.log("INFO: req.cookies in user_status: ", req.cookies);
    const token = req.cookies.JWT;
    if (token) {
        jwt.verify(token, 'hello', async (err, decodedToken) => {
            const currentUsername = decodedToken.username;
            console.log("INFO: Current user's decodedToken: ", decodedToken);
            
            User.status(username, status, (err, data) => {
                res.send(data)
            })
        });
    } else {
        console.log('JWT cookie not found')
    }
}


